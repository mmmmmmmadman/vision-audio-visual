# VAV 工作日誌 - 版本 11042100

**日期**: 2025-11-04 21:00
**版本號**: 11042100

---

## 主要修改

### 1. CV 檢測來源優化

**目標**: 讓 CV 檢測能夠識別 Camera 或 SD img2img 輸出，但不受 Multiverse 影響

**修改檔案**: `vav/core/controller.py` (行 360-375)

**修改內容**:
- 新增 `cv_input_frame` 變數，動態選擇 CV 檢測來源
- 當 SD img2img 啟用且有輸出時，使用 SD 輸出作為檢測來源
- 否則使用原始 Camera 畫面
- Multiverse 渲染結果不影響 CV 檢測

**技術細節**:
```python
# Determine CV detection source: SD output (if available) or camera
cv_input_frame = frame  # Default: use camera frame
if self.sd_enabled and self.sd_img2img:
    sd_output = self.sd_img2img.get_current_output()
    if sd_output is not None:
        # Ensure size matches
        if sd_output.shape[:2] != frame.shape[:2]:
            cv_input_frame = cv2.resize(sd_output, (frame.shape[1], frame.shape[0]))
        else:
            cv_input_frame = sd_output

# Convert to grayscale for edge detection (from SD or camera, not multiverse)
gray = cv2.cvtColor(cv_input_frame, cv2.COLOR_BGR2GRAY)

# Generate sequence values from edge detection
self.contour_cv_generator.sample_edge_sequences(gray)
```

---

## 三種運作模式

| 模式 | CV 檢測來源 | 視覺顯示 |
|------|------------|----------|
| **純 Camera** | Camera | Camera |
| **Camera + Multiverse** | Camera | Camera + Multiverse 混合 |
| **SD + Multiverse** | SD 輸出 | SD + Multiverse 混合 |

---

## 技術優勢

1. **視覺一致性**: CV overlay（SEQ 線、ENV 圈、Anchor 圓）與檢測來源完全對應
2. **藝術性增強**: 當 SD 啟用時，CV 可捕捉風格化後的邊緣特徵
3. **Multiverse 獨立**: 保持音頻可視化層的獨立性，不干擾 CV 檢測
4. **向後兼容**: SD 未啟用時，行為與原始版本完全相同
5. **效能優化**: 只在需要時才調用 SD 輸出，無額外開銷

---

## CV 輸出邏輯說明

### 五個 CV 輸出

1. **SEQ1 (Sequencer 1)**: 從 Anchor 點水平雙向採樣邊緣強度 → 0-10V
2. **SEQ2 (Sequencer 2)**: 從 Anchor 點垂直雙向採樣邊緣強度 → 0-10V
3. **ENV1 (Envelope 1)**: SEQ1 > 5V 時觸發 ADSR 包絡
4. **ENV2 (Envelope 2)**: SEQ2 > 5V 時觸發 ADSR 包絡
5. **ENV3 (Envelope 3)**: SEQ1 ≤ 5V 且 SEQ2 ≤ 5V 時觸發 ADSR 包絡

### 核心技術
- **邊緣檢測**: Sobel 算子計算梯度強度
- **雙向採樣**: 從 Anchor 點向左右/上下探索邊緣
- **統一時鐘**: 所有 CV 共用 BPM-based 時鐘，同步步進
- **5V 閾值**: 劃分高/低電壓區，創造互補節奏

---

## GUI 優化記錄

### 已移除控制項
- ✅ Threshold 滑桿（第一列）- 已無作用
- ✅ Smoothing 滑桿（第一列）- 已無作用
- ✅ SD Prompt 標籤（第二列）- 釋放空間

### 視覺增強
- ✅ CV 輸出波形線寬: 2px → 3px (更清晰)
- ✅ Anchor 圓圈: 新增粉白色圓圈，與 2D 控制 Pad 設計一致
- ✅ Y 軸座標: 修正 2D 控制與主視覺的上下對應

---

## 測試確認

- ✅ 程式正常啟動
- ✅ Camera 模式 CV 檢測正常
- ✅ SD img2img 模式 CV 檢測切換正常
- ✅ Multiverse 渲染不影響 CV 檢測
- ✅ 語法檢查通過
- ✅ 所有功能運作正常

---

## 下一步計劃

- 效能監控與優化
- SD img2img 延遲優化（如需要）
- 使用者回饋收集

---

**版本標記**: VAV_11042100
**狀態**: ✅ 穩定版本，可投入使用
